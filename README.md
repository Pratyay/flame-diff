# Flame Graph Diff Tool

A Flask-based backend server for comparing flame graphs and analyzing performance differences between two profiling sessions. This tool processes collapsed flame graph files and provides detailed diff analytics via REST API.

![Flame UI](https://github.com/Pratyay/flame-diff/blob/main/img/flame.jpg)

## Features

- **REST API**: Upload and compare two collapsed flame graph files via HTTP endpoints
- **Comprehensive Analysis**: Detailed categorization of changes:
  - **Added**: Stack traces that appear only in the new profile
  - **Removed**: Stack traces that exist only in the old profile 
  - **Increased**: Stack traces with higher sample counts (performance regressions)
  - **Decreased**: Stack traces with lower sample counts (performance improvements)
  - **Unchanged**: Stack traces with identical sample counts
- **Statistical Metrics**: 
  - Absolute and percentage changes for each stack trace
  - Overall sample count changes and percentage differences
  - Sorted results by significance (highest impact changes first)
- **Robust Parser**: Handles collapsed flame graph format with error handling
- **Health Check**: Built-in health monitoring endpoint

## Architecture

The server consists of two main components:
- **FlameGraphParser**: Parses collapsed flame graph files and extracts stack traces with sample counts
- **FlameGraphDiffer**: Compares two parsed flame graphs and generates comprehensive diff analytics

## Setup

### Option 1: Using Virtual Environment (Recommended)
1. Clone the repository
   ```bash
   git clone https://github.com/Pratyay/flame-diff
   ```

2. Switch to flame directory
   ```bash
   cd flame-diff
   ``` 

3. Create and activate virtual environment:
   ```bash
   python3 -m venv .
   source bin/activate
   ```

4. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

5. Run the application:
   ```bash
   python3 app.py
   ```

### Option 2: Direct Installation

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

2. Run the application:
   ```bash
   python3 app.py
   ```

The server will start on `http://localhost:5000` with debug mode enabled.

## Usage

1. **Prepare your flame graph files**: Make sure you have two collapsed flame graph files (`.collapsed` format)
   - These are typically generated by async-profiler with commands like:
     ```bash
     java -jar async-profiler.jar -d 30 -f profile.collapsed <pid>
     ```

2. **Upload files**: 
   - Select your "Old" flame graph file (baseline)
   - Select your "New" flame graph file (comparison)

3. **Analyze results**:
   - View the summary showing total sample changes
   - Browse categorized changes to identify performance regressions or improvements
   - Use the stack traces to pinpoint specific code paths that changed

## File Format

The tool expects collapsed flame graph files where each line contains:
```
<line_number>|<stack_trace> <sample_count>
```

Example:
```
1|java/lang/Thread.run_[j];com/example/MyClass.method_[j] 42
2|java/lang/Thread.run_[j];com/example/OtherClass.process_[j] 18
```

## Interpreting Results

![Compare UI](https://github.com/Pratyay/flame-diff/blob/main/img/compare.jpg)

- **Green (Added)**: New stack traces that appear only in the new profile
- **Red (Removed)**: Stack traces that existed in the old profile but not the new one
- **Orange (Increased)**: Stack traces with higher sample counts in the new profile
- **Blue (Decreased)**: Stack traces with lower sample counts in the new profile

The percentage changes help identify the most significant performance differences between the two profiling sessions.

#### Click to expand individual stacktrace
![Stack UI](https://github.com/Pratyay/flame-diff/blob/main/img/stack.jpg)


## Tips

- Focus on stack traces with the highest percentage changes
- Look for new hot paths in the "Added" category
- Check if optimizations worked by looking at "Decreased" traces
- Use the stack trace information to navigate to specific code areas
